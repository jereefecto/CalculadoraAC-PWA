<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Calculadora Profesional de AC</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Calculadora AC Pro">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <!-- Theme Colors -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1A5F7A" media="(prefers-color-scheme: dark)">

    <!-- CSS Frameworks & Libraries -->
    <script src="https://cdn.tailwindcss.com "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js "></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js "></script>
    <script src="https://unpkg.com/ @phosphor-icons/web"></script>

    <!-- Custom Styles -->
    <style>
        :root {
            --bg-color: #f0f4f8;
            --card-bg-color: #ffffff;
            --text-color: #1A5F7A;
            --text-muted-color: #6b7280;
            --border-color: #e5e7eb;
            --primary-color: #57B869;
            --accent-color: #15A2D1;
        }
        html.dark {
            --bg-color: #1A5F7A;
            --card-bg-color: #247494;
            --text-color: #ffffff;
            --text-muted-color: #a0d3e8;
            --border-color: #247494;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .card {
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
        }
        .form-step { display: none; }
        .form-step.active { display: block; }
        .input-field {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .icon-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .icon-label i {
            font-size: 1.2rem;
            color: var(--primary-color);
        }
        .theme-switch {
            display: inline-block;
            height: 24px;
            position: relative;
            width: 50px;
        }
        .slider {
            background-color: #ccc;
            bottom: 0;
            cursor: pointer;
            left: 0;
            position: absolute;
            right: 0;
            top: 0;
            transition: .4s;
        }
        .slider:before {
            background-color: #fff;
            bottom: 4px;
            content: "";
            height: 16px;
            left: 4px;
            position: absolute;
            transition: .4s;
            width: 16px;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        .btn {
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            font-weight: 600;
            color: white;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-bottom: 3px solid rgba(0, 0, 0, 0.3);
        }
        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            border-bottom-width: 1px;
        }
        .btn-primary { background-color: var(--primary-color); border-color: #469454; }
        .btn-secondary { background-color: var(--text-muted-color); border-color: #5a626b; }
        .btn-accent { background-color: var(--accent-color); border-color: #118ab0; }
        .btn-warning { background-color: #f59e0b; border-color: #d97706; }

        .chart-container {
            position: relative;
            max-height: 350px;
            margin: auto;
        }

        @media print {
            body * { visibility: hidden; }
            #results-column, #results-column * { visibility: visible; }
            #results-column {
                position: absolute;
                left: 0;
                top: 0;
                width: 216mm;
                height: 279mm;
                padding: 15mm;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            .no-print { display: none; }
            .chart-container {
                break-inside: avoid;
                page-break-inside: avoid;
                max-height: 90mm;
            }
        }
    </style>
</head>
<body class="p-4">
<div class="w-full max-w-[216mm] mx-auto"> <!-- Ancho máximo de 8.5 pulgadas -->

    <!-- Header -->
    <header class="flex justify-between items-center mb-6 no-print">
        <div>
            <h1 class="text-2xl font-bold" data-lang="title">Calculadora Profesional de AC</h1>
            <p class="text-sm text-muted-color" data-lang="description">Una herramienta completa para el cálculo térmico.</p>
        </div>
        <div class="flex items-center space-x-4">
            <select id="lang-select" class="input-field rounded-md text-sm">
                <option value="es">Español</option>
                <option value="en">English</option>
            </select>
            <div class="theme-switch-wrapper">
                <label class="theme-switch" for="theme-toggle">
                    <input type="checkbox" id="theme-toggle" aria-label="Activar modo oscuro" title="Activar modo oscuro"/>
                    <div class="slider round"></div>
                </label>
            </div>
        </div>
    </header>

    <!-- Formulario -->
    <div id="form-container" class="card rounded-xl shadow-lg p-6 no-print">
        <form id="calculator-form">
            <!-- Paso 1: Dimensiones -->
            <div id="step-1" class="form-step active">
                <h3 class="font-bold text-xl mb-4" data-lang="dimensionsTitle">1. Dimensiones y Ubicación</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="length" class="icon-label"><i class="ph-bold ph-arrows-out-line-horizontal"></i><span data-lang="length">Largo (m)</span></label>
                            <input type="number" id="length" value="5" step="0.1" class="w-full p-2 input-field rounded-md">
                        </div>
                        <div>
                            <label for="width" class="icon-label"><i class="ph-bold ph-arrows-out-simple"></i><span data-lang="width">Ancho (m)</span></label>
                            <input type="number" id="width" value="4" step="0.1" class="w-full p-2 input-field rounded-md">
                        </div>
                        <div>
                            <label for="height" class="icon-label"><i class="ph-bold ph-arrows-out-line-vertical"></i><span data-lang="height">Altura (m)</span></label>
                            <input type="number" id="height" value="2.5" step="0.1" class="w-full p-2 input-field rounded-md">
                        </div>
                    </div>
                    <div>
                        <label for="city" class="icon-label"><i class="ph-bold ph-map-pin"></i><span data-lang="city">Ciudad/Región</span></label>
                        <input type="text" id="city" placeholder="Ej: Santo Domingo" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div>
                        <label for="climate-zone" class="icon-label"><i class="ph-bold ph-sun"></i><span data-lang="climateZone">Zona Climática</span></label>
                        <select id="climate-zone" class="w-full p-2 input-field rounded-md">
                            <option value="1.0" selected data-lang-es="Fría" data-lang-en="Cold">Fría</option>
                            <option value="1.1" data-lang-es="Templada" data-lang-en="Mild">Templada</option>
                            <option value="1.2" data-lang-es="Cálida" data-lang-en="Hot">Cálida</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Estructura -->
            <div id="step-2" class="form-step">
                <h3 class="font-bold text-xl mb-4" data-lang="structureTitle">2. Estructura y Aislamiento</h3>
                <div class="space-y-4">
                    <div>
                        <label for="insulation-walls" class="icon-label"><i class="ph-bold ph-wall"></i><span data-lang="insulationWalls">Aislamiento de Paredes</span></label>
                        <select id="insulation-walls" class="w-full p-2 input-field rounded-md">
                            <option value="1.0" data-lang-es="Bueno" data-lang-en="Good">Bueno</option>
                            <option value="1.1" selected data-lang-es="Regular" data-lang-en="Average">Regular</option>
                            <option value="1.2" data-lang-es="Malo" data-lang-en="Poor">Malo</option>
                        </select>
                    </div>
                    <div>
                        <label for="insulation-roof" class="icon-label"><i class="ph-bold ph-house-line"></i><span data-lang="insulationRoof">Aislamiento de Techo</span></label>
                        <select id="insulation-roof" class="w-full p-2 input-field rounded-md">
                            <option value="1.0" data-lang-es="Bueno" data-lang-en="Good">Bueno</option>
                            <option value="1.1" selected data-lang-es="Regular" data-lang-en="Average">Regular</option>
                            <option value="1.2" data-lang-es="Malo" data-lang-en="Poor">Malo</option>
                        </select>
                    </div>
                    <div>
                        <label for="windows" class="icon-label"><i class="ph-bold ph-window"></i><span data-lang="windows"># de Ventanas</span></label>
                        <input type="number" id="windows" value="3" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div>
                        <label for="glass-type" class="icon-label"><i class="ph-bold ph-building"></i><span data-lang="glassType">Tipo de Vidrio</span></label>
                        <select id="glass-type" class="w-full p-2 input-field rounded-md">
                            <option value="1.0" data-lang-es="Simple" data-lang-en="Single">Simple</option>
                            <option value="1.5" selected data-lang-es="Doble" data-lang-en="Double">Doble</option>
                            <option value="2.0" data-lang-es="Low-E" data-lang-en="Low-E">Low-E</option>
                        </select>
                    </div>
                    <div>
                        <label for="sun-exposure" class="icon-label"><i class="ph-bold ph-sun-horizon"></i><span data-lang="sunExposure">Orientación con más sol</span></label>
                        <select id="sun-exposure" class="w-full p-2 input-field rounded-md">
                            <option value="1.15" data-lang-es="Este (Sol de mañana)" data-lang-en="East (Morning Sun)">Este</option>
                            <option value="1.25" selected data-lang-es="Oeste (Sol de tarde)" data-lang-en="West (Afternoon Sun)">Oeste</option>
                            <option value="1.1" data-lang-es="Sur" data-lang-en="South">Sur</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Paso 3: Carga Interna -->
            <div id="step-3" class="form-step">
                <h3 class="font-bold text-xl mb-4" data-lang="internalLoadTitle">3. Carga Térmica Interna</h3>
                <div class="space-y-4">
                    <div>
                        <label for="occupants" class="icon-label"><i class="ph-bold ph-users-three"></i><span data-lang="occupants">Ocupantes habituales</span></label>
                        <input type="number" id="occupants" value="4" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div>
                        <label for="computers" class="icon-label"><i class="ph-bold ph-monitor"></i><span data-lang="computers"># Computadoras / Laptops</span></label>
                        <input type="number" id="computers" value="2" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div>
                        <label for="lights" class="icon-label"><i class="ph-bold ph-lightbulb"></i><span data-lang="lights">Luces (Watts totales)</span></label>
                        <input type="number" id="lights" value="200" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div>
                        <label for="equipment" class="icon-label"><i class="ph-bold ph-tv"></i><span data-lang="equipment">Otros equipos (TV, etc.)</span></label>
                        <input type="number" id="equipment" value="0" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div>
                        <label for="usage-hours" class="icon-label"><i class="ph-bold ph-timer"></i><span data-lang="usageHours">Horas de Uso Diario</span></label>
                        <input type="number" id="usage-hours" value="8" class="w-full p-2 input-field rounded-md">
                    </div>
                </div>
            </div>

            <!-- Paso 4: Opciones Avanzadas -->
            <div id="step-4" class="form-step">
                <h3 class="font-bold text-xl mb-4" data-lang="advancedOptions">4. Opciones Avanzadas</h3>
                <div class="space-y-4">
                    <div>
                        <label for="usage-type" class="icon-label"><i class="ph-bold ph-buildings"></i><span data-lang="usageType">Tipo de Uso</span></label>
                        <select id="usage-type" class="w-full p-2 input-field rounded-md">
                            <option value="1.0" data-lang-es="Normal (Hogar)" data-lang-en="Normal Use (Home)">Normal</option>
                            <option value="1.2" selected data-lang-es="Intensivo (Oficina)" data-lang-en="Intensive (Office)">Intensivo</option>
                        </select>
                    </div>
                    <div>
                        <label for="infiltration" class="icon-label"><i class="ph-bold ph-door-open"></i><span data-lang="infiltration">Infiltración de Aire Exterior</span></label>
                        <select id="infiltration" class="w-full p-2 input-field rounded-md">
                            <option value="0.3" data-lang-es="Baja" data-lang-en="Low">Baja</option>
                            <option value="0.5" selected data-lang-es="Media" data-lang-en="Medium">Media</option>
                            <option value="0.7" data-lang-es="Alta" data-lang-en="High">Alta</option>
                        </select>
                    </div>
                    <div>
                        <label for="refrigerant" class="icon-label"><i class="ph-bold ph-drop"></i><span data-lang="refrigerantType">Tipo de Refrigerante</span></label>
                        <select id="refrigerant" class="w-full p-2 input-field rounded-md">
                            <option value="R410A" selected>R410A</option>
                            <option value="R32">R32</option>
                            <option value="R290">R290 (Propano)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Botones de navegación -->
            <div class="mt-8 flex justify-between">
                <button type="button" id="prev-btn" class="btn btn-secondary hidden" data-lang="prev">Anterior</button>
                <button type="button" id="next-btn" class="btn btn-primary" data-lang="next">Siguiente</button>
                <button type="submit" id="calc-btn" class="btn btn-primary hidden" data-lang="calculate">Calcular</button>
            </div>
            <p class="text-xs text-muted-color mt-4" data-lang="disclaimer">🔒 Todos los cálculos se realizan en tu dispositivo. Ningún dato es enviado a nuestros servidores.</p>
        </form>
    </div>

    <!-- Resultados -->
    <div id="results-column" class="card rounded-xl shadow-lg p-6 hidden">
        <div id="report-content">
            <h2 class="font-bold text-2xl mb-4" data-lang="resultsTitle">Resultados del Cálculo</h2>
            <div class="text-center mb-6">
                <p class="text-lg text-muted-color" data-lang="requiredCapacity">Capacidad Requerida</p>
                <p class="text-5xl font-bold" id="btu-result" style="color: var(--primary-color);">12,000 BTU/h</p>
                <p class="text-muted-color" id="kw-result">(3.5 kW)</p>
            </div>
            <div class="mb-6 chart-container">
                <h3 class="font-bold text-xl mb-2" data-lang="loadBreakdown">Desglose de Carga Térmica</h3>
                <canvas id="heatLoadChart"></canvas>
            </div>
            <div class="space-y-4">
                <div id="rec-type"></div>
                <div id="rec-electrical"></div>
                <div id="rec-refrigerant"></div>
                <div>
                    <h3 class="font-bold text-xl mb-2" data-lang="consumptionComparison">Comparativa de Consumo Mensual</h3>
                    <table class="w-full table-auto border-collapse">
                        <thead>
                            <tr class="text-left">
                                <th data-lang="efficiency">Eficiencia</th>
                                <th class="text-right" data-lang="consumption">Consumo (kWh)</th>
                                <th class="text-right" data-lang="monthlyCost">Costo Mensual</th>
                            </tr>
                        </thead>
                        <tbody id="consumption-table-body">
                            <!-- Datos dinámicos -->
                        </tbody>
                    </table>
                    <div class="mt-4">
                        <label for="energy-cost" class="block mb-2" data-lang="costPerKwh">Costo kWh ($):</label>
                        <input type="number" id="energy-cost" value="0.20" step="0.01" class="w-full p-2 input-field rounded-md">
                    </div>
                    <div class="mt-4">
                        <label for="custom-seer" class="block mb-2" data-lang="customSeer">SEER Personalizado:</label>
                        <input type="number" id="custom-seer" value="14" step="0.1" class="w-full p-2 input-field rounded-md">
                    </div>
                </div>
                <div>
                    <h3 class="font-bold text-xl mb-2" data-lang="maintenanceReminders">Recordatorios de Mantenimiento</h3>
                    <div class="flex space-x-2">
                        <button id="add-3-months" class="btn btn-accent w-full" data-lang="add3Months">Añadir a 3 meses</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-6 flex space-x-2 no-print">
            <button id="download-pdf" class="btn btn-accent flex-grow" data-lang="downloadPdf">Descargar Reporte en PDF</button>
        </div>
        <button id="reset-calc" class="mt-4 btn btn-warning w-full no-print" data-lang="resetCalc">Reiniciar Cálculo</button>
    </div>

</div>

<!-- Script Principal -->
<script>
    const initApp = () => {
        const state = {
            currentStep: 1,
            totalSteps: 4,
            lang: 'es'
        };

        const langData = {
            es: {
                title: "Calculadora Profesional de AC",
                description: "Una herramienta completa para el cálculo térmico.",
                languageLabel: "Idioma:",
                stepProgress: "Paso %s de %s",
                prev: "Anterior",
                next: "Siguiente",
                calculate: "Calcular",
                dimensionsTitle: "1. Dimensiones y Ubicación",
                length: "Largo (m)",
                width: "Ancho (m)",
                height: "Altura (m)",
                city: "Ciudad/Región",
                climateZone: "Zona Climática",
                structureTitle: "2. Estructura y Aislamiento",
                insulationWalls: "Aislamiento de Paredes",
                insulationRoof: "Aislamiento de Techo",
                windows: "# de Ventanas",
                glassType: "Tipo de Vidrio",
                sunExposure: "Orientación con más sol",
                internalLoadTitle: "3. Carga Térmica Interna",
                occupants: "Ocupantes habituales",
                computers: "# Computadoras / Laptops",
                lights: "Luces (Watts totales)",
                equipment: "Otros equipos (TV, etc.)",
                usageHours: "Horas de Uso Diario",
                advancedOptions: "4. Opciones Avanzadas",
                usageType: "Tipo de Uso",
                infiltration: "Infiltración de Aire Exterior",
                refrigerantType: "Tipo de Refrigerante",
                resultsTitle: "Resultados del Cálculo",
                requiredCapacity: "Capacidad Requerida",
                loadBreakdown: "Desglose de Carga Térmica",
                recommendations: "Recomendaciones",
                consumptionComparison: "Comparativa de Consumo Mensual",
                costPerKwh: "Costo kWh ($):",
                efficiency: "Eficiencia",
                consumption: "Consumo (kWh)",
                monthlyCost: "Costo Mensual",
                customSeer: "SEER Personalizado:",
                maintenanceReminders: "Recordatorios de Mantenimiento",
                add3Months: "Añadir a 3 meses",
                downloadPdf: "Descargar Reporte en PDF",
                resetCalc: "Nuevo Cálculo",
                disclaimer: "🔒 Todos los cálculos se realizan en tu dispositivo. Ningún dato es enviado a nuestros servidores."
            },
            en: {
                title: "Professional AC Calculator",
                description: "A complete tool for thermal load calculation.",
                languageLabel: "Language:",
                stepProgress: "Step %s of %s",
                prev: "Previous",
                next: "Next",
                calculate: "Calculate",
                dimensionsTitle: "1. Dimensions & Location",
                length: "Length (m)",
                width: "Width (m)",
                height: "Height (m)",
                city: "City/Region",
                climateZone: "Climate Zone",
                structureTitle: "2. Structure and Insulation",
                insulationWalls: "Wall Insulation",
                insulationRoof: "Roof Insulation",
                windows: "# of Windows",
                glassType: "Glass Type",
                sunExposure: "Sun Exposure Direction",
                internalLoadTitle: "3. Internal Heat Load",
                occupants: "Regular Occupants",
                computers: "# Computers / Laptops",
                lights: "Lights (Total Watts)",
                equipment: "Other Equipment (TV, etc.)",
                usageHours: "Daily Usage Hours",
                advancedOptions: "4. Advanced Options",
                usageType: "Usage Type",
                infiltration: "Outdoor Air Infiltration",
                refrigerantType: "Refrigerant Type",
                resultsTitle: "Calculation Results",
                requiredCapacity: "Required Capacity",
                loadBreakdown: "Heat Load Breakdown",
                recommendations: "Recommendations",
                consumptionComparison: "Monthly Consumption Comparison",
                costPerKwh: "kWh Cost ($):",
                efficiency: "Efficiency",
                consumption: "Consumption (kWh)",
                monthlyCost: "Monthly Cost",
                customSeer: "Custom SEER:",
                maintenanceReminders: "Maintenance Reminders",
                add3Months: "Add to 3 Months",
                downloadPdf: "Download PDF Report",
                resetCalc: "New Calculation",
                disclaimer: "🔒 All calculations are done locally on your device. No data is sent to our servers."
            }
        };

        const steps = document.querySelectorAll('.form-step');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const calcBtn = document.getElementById('calc-btn');
        const progressBar = document.getElementById('progress-bar');

        const langSelect = document.getElementById('lang-select');
        const energyCostInput = document.getElementById('energy-cost');
        const customSeerInput = document.getElementById('custom-seer');
        let heatLoadChart;

        // Funciones
        const updateLanguage = (lang) => {
            state.lang = lang;
            document.documentElement.lang = lang;
            document.title = langData[lang].title;
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.getAttribute('data-lang');
                if (langData[lang][key]) {
                    el.textContent = langData[lang][key]
                        .replace('%s', state.currentStep)
                        .replace('%s', state.totalSteps);
                }
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-placeholder');
                if (langData[lang][key]) {
                    el.placeholder = langData[lang][key];
                }
            });
            document.querySelectorAll('option[data-lang-es]').forEach(option => {
                option.textContent = option.getAttribute(`data-lang-${lang}`);
            });
        };

        const updateFormNavigation = () => {
            prevBtn.classList.toggle('hidden', state.currentStep === 1);
            nextBtn.classList.toggle('hidden', state.currentStep === state.totalSteps);
            calcBtn.classList.toggle('hidden', state.currentStep !== state.totalSteps);

            document.querySelector('[data-lang="stepProgress"]').textContent =
                langData[state.lang].stepProgress
                    .replace('%s', state.currentStep)
                    .replace('%s', state.totalSteps);

            progressBar.style.width = `${(state.currentStep / state.totalSteps) * 100}%`;

            steps.forEach((step, index) =>
                step.classList.toggle('active', (index + 1) === state.currentStep)
            );
        };

        const handleNavigation = (direction) => {
            const newStep = Math.max(1, Math.min(state.totalSteps, state.currentStep + direction));
            if (newStep !== state.currentStep) {
                state.currentStep = newStep;
                updateFormNavigation();
            }
        };

        const roundToCommercialBtu = (btu) => {
            const commercialSizes = [9000, 12000, 18000, 24000, 36000, 48000, 60000];
            for (const size of commercialSizes) {
                if (btu <= size) return size;
            }
            return Math.ceil(btu / 6000) * 6000;
        };

        const calculateThermalLoad = () => {
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;
            const climateZoneFactor = parseFloat(document.getElementById('climate-zone').value) || 1.0;
            const wallInsulation = parseFloat(document.getElementById('insulation-walls').value) || 1.0;
            const roofInsulation = parseFloat(document.getElementById('insulation-roof').value) || 1.0;
            const windowCount = parseInt(document.getElementById('windows').value) || 0;
            const glassType = parseFloat(document.getElementById('glass-type').value) || 1.0;
            const sunExposure = parseFloat(document.getElementById('sun-exposure').value) || 1.0;
            const occupants = parseInt(document.getElementById('occupants').value) || 0;
            const computers = parseInt(document.getElementById('computers').value) || 0;
            const lights = parseInt(document.getElementById('lights').value) || 0;
            const otherEquipment = parseInt(document.getElementById('equipment').value) || 0;
            const usageHours = parseInt(document.getElementById('usage-hours').value) || 0;
            const usageType = parseFloat(document.getElementById('usage-type').value) || 1.0;
            const infiltration = parseFloat(document.getElementById('infiltration').value) || 0.5;
            const refrigerantType = document.getElementById('refrigerant').value || 'R410A';

            const volume = length * width * height;
            const baseVolumeFactor = 35; // BTU/m³
            const peopleFactor = 600; // BTU/person
            const computerFactor = 500; // BTU/computer
            const lightFactor = 3.41; // BTU/Watt
            const otherFactor = 600; // BTU/unit
            const windowFactor = 1500; // BTU/window

            const btuVolume = volume * baseVolumeFactor * wallInsulation * roofInsulation * climateZoneFactor;
            const btuPeople = occupants * peopleFactor;
            const btuComputers = computers * computerFactor;
            const btuLights = lights * lightFactor;
            const btuOther = otherEquipment * otherFactor;
            const btuWindows = windowCount * windowFactor * glassType * sunExposure;
            const btuInfiltration = volume * infiltration * 0.15;

            const btuBase = btuVolume + btuPeople + btuComputers + btuLights + btuOther + btuWindows + btuInfiltration;
            const usageMultiplier = usageHours >= 10 ? 1.0 : usageHours > 6 ? 0.9 : 0.75;
            const safetyFactor = 1.10;

            const btu = btuBase * usageMultiplier * usageType * safetyFactor;
            const btuRounded = roundToCommercialBtu(btu);
            const kw = (btuRounded / 3412).toFixed(1);

            const breakdown = {
                estructura: btuVolume,
                ventanas: btuWindows,
                personas: btuPeople,
                equipos: btuComputers + btuLights + btuOther
            };

            const refrigerants = {
                R410A: { name: 'R410A', gwp: '2088', odp: '0', info: 'Refrigerante ecológico de nueva generación' },
                R32: { name: 'R32', gwp: '675', odp: '0', info: 'Menor impacto ambiental que R410A' },
                R290: { name: 'R290 (Propano)', gwp: '3', odp: '0', info: 'Refrigerante natural, muy eficiente pero inflamable' }
            };

            const refrigerant = refrigerants[refrigerantType];

            return {
                btuRounded,
                kw,
                breakdown,
                refrigerant
            };
        };

        const updateResults = (result) => {
            document.getElementById('btu-result').textContent = `${result.btuRounded.toLocaleString()} BTU/h`;
            document.getElementById('kw-result').textContent = `(${result.kw} kW)`;

            const recTypeEl = document.getElementById('rec-type');
            const recElectricalEl = document.getElementById('rec-electrical');
            const recRefrigerantEl = document.getElementById('rec-refrigerant');

            let typeRecHTML = '';
            let elecRecHTML = '<strong>Instalación Eléctrica:</strong> ';
            let refrigerantHTML = `<strong>Refrigerante Seleccionado: ${result.refrigerant.name}</strong>`;
            refrigerantHTML += `<p class="text-sm text-muted-color mt-1"><strong>GWP:</strong> ${result.refrigerant.gwp}| <strong>ODP:</strong> ${result.refrigerant.odp}<br>${result.refrigerant.info}</p>`;

            if (result.btuRounded <= 12000) {
                typeRecHTML = `<strong>Tipo de Sistema:</strong> Split Inverter (1x1)<p class="text-sm text-muted-color mt-1"><strong>Ideal para:</strong> Habitaciones, estudios u oficinas pequeñas.<br><strong>Ventajas:</strong> Alta eficiencia energética, bajo nivel de ruido y control individual.</p>`;
                elecRecHTML += 'Breaker 20A, cable #12 AWG. Se recomienda un punto de conexión dedicado y protector de voltaje.';
            } else if (result.btuRounded <= 24000) {
                typeRecHTML = `<strong>Tipo de Sistema:</strong> Split Inverter de Alta Capacidad<p class="text-sm text-muted-color mt-1"><strong>Ideal para:</strong> Salas de estar grandes, áreas de trabajo abiertas.<br><strong>Ventajas:</strong> Excelente capacidad de enfriamiento con eficiencia Inverter.</p>`;
                elecRecHTML += 'Breaker 30A, cable #10 AWG. Verificar capacidad del panel eléctrico principal.';
            } else if (result.btuRounded <= 36000) {
                typeRecHTML = `<strong>Tipo de Sistema:</strong> Multi-Split o Central por Conductos<p class="text-sm text-muted-color mt-1"><strong>Ideal para:</strong> Apartamentos, varias oficinas o residencias medianas.<br><strong>Ventajas:</strong> Climatiza múltiples zonas (Multi-Split) o de forma uniforme (Central).</p>`;
                elecRecHTML += 'Breaker 40A, cable #8 AWG. Requiere evaluación profesional y posible subpanel.';
            } else {
                typeRecHTML = `<strong>Tipo de Sistema:</strong> Sistema VRV/VRF o Central de Alta Capacidad<p class="text-sm text-muted-color mt-1"><strong>Ideal para:</strong> Edificios comerciales, residencias grandes.<br><strong>Ventajas:</strong> Máxima eficiencia, control zonificado avanzado.</p>`;
                elecRecHTML += 'Evaluación profesional obligatoria. Breaker > 50A, cable #6 AWG o superior.';
            }

            recTypeEl.innerHTML = typeRecHTML;
            recElectricalEl.innerHTML = elecRecHTML;
            recRefrigerantEl.innerHTML = refrigerantHTML;

            updateConsumptionTable(result.btuRounded);
        };

        const updateConsumptionTable = (btu) => {
            const seerValues = [
                { name: 'Estándar (SEER 10)', seer: 10 },
                { name: 'Alta Eficiencia (SEER 14)', seer: 14 },
                { name: 'Premium (SEER 16)', seer: 16 }
            ];

            const hoursPerMonth = 720; // Promedio mensual
            const energyCost = parseFloat(energyCostInput.value) || 0.20;
            const kwhPerMonthBase = btu / seerValues[1].seer / 1000 * hoursPerMonth;

            const tableBody = document.getElementById('consumption-table-body');
            tableBody.innerHTML = '';

            seerValues.forEach(eff => {
                const kwhPerMonth = btu / eff.seer / 1000 * hoursPerMonth;
                const costPerMonth = kwhPerMonth * energyCost;
                tableBody.innerHTML += `
                    <tr>
                        <td>${eff.name}</td>
                        <td class="text-right">${kwhPerMonth.toFixed(0)}</td>
                        <td class="text-right">$${costPerMonth.toFixed(2)}</td>
                    </tr>
                `;
            });

            // Actualizar gráfico
            const ctx = document.getElementById('heatLoadChart').getContext('2d');
            if (heatLoadChart) heatLoadChart.destroy();

            heatLoadChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Estructura', 'Ventanas', 'Personas', 'Equipos'],
                    datasets: [{
                        label: 'Carga Térmica',
                        data: [btu * 0.4, btu * 0.2, btu * 0.2, btu * 0.2],
                        backgroundColor: ['#57B869', '#15A2D1', '#FFA500', '#FF6B6B']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        };

        const generateIcsFile = (months) => {
            const now = new Date();
            const eventDate = new Date(now.setMonth(now.getMonth() + months));
            const toISOString = (date) => date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            const icsContent = `BEGIN:VCALENDAR\r
VERSION:2.0\r
PRODID:-//CalculadoraAC//NONSGML v1.0//EN\r
BEGIN:VEVENT\r
UID:${Date.now()}@calculadora.ac\r
DTSTAMP:${toISOString(new Date())}\r
DTSTART:${toISOString(eventDate)}\r
DTEND:${toISOString(new Date(eventDate.getTime() + 3600000))}\r
SUMMARY:Mantenimiento Preventivo de AC\r
DESCRIPTION:Limpieza de filtros, serpentín y desagüe. Revisión de gas y componentes eléctricos.\r
LOCATION:Hogar u Oficina\r
STATUS:CONFIRMED\r
BEGIN:VALARM\r
TRIGGER:-PT15M\r
ACTION:DISPLAY\r
DESCRIPTION:Reminder\r
END:VALARM\r
END:VEVENT\r
END:VCALENDAR`;

            const blob = new Blob([icsContent], { type: 'text/calendar' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `mantenimiento_ac_${months}_meses.ics`;
            link.click();
            URL.revokeObjectURL(url);
        };

        const downloadPdfBtn = document.getElementById('download-pdf');
        const resetCalcBtn = document.getElementById('reset-calc');

        // Event Listeners
        langSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
        });

        prevBtn.addEventListener('click', () => handleNavigation(-1));
        nextBtn.addEventListener('click', () => handleNavigation(1));

        document.getElementById('calculator-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const result = calculateThermalLoad();
            updateResults(result);
        });

        energyCostInput.addEventListener('input', () => {
            const result = calculateThermalLoad();
            updateConsumptionTable(result.btuRounded);
        });

        customSeerInput.addEventListener('input', () => {
            const result = calculateThermalLoad();
            updateConsumptionTable(result.btuRounded);
        });

        document.getElementById('add-3-months').addEventListener('click', () => {
            generateIcsFile(3);
        });

        document.getElementById('theme-toggle').addEventListener('change', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        });

        document.getElementById('reset-calc').addEventListener('click', () => {
            location.reload();
        });

        document.getElementById('download-pdf').addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'p',
                unit: 'mm',
                format: [216, 279] // tamaño carta
            });
            const reportContent = document.getElementById('report-content');

            html2canvas(reportContent, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const ratio = canvas.height / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfWidth * ratio);
                pdf.save('reporte_ac.pdf');
            });
        });

        // Inicialización
        const savedLang = localStorage.getItem('lang') || 'es';
        const savedDarkMode = localStorage.getItem('darkMode') === 'true';

        langSelect.value = savedLang;
        updateLanguage(savedLang);
        updateFormNavigation();

        if (savedDarkMode) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-toggle').checked = true;
        }

        document.getElementById('lang-select').value = savedLang;
        updateLanguage(savedLang);
    };

    // Iniciar aplicación
    window.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
