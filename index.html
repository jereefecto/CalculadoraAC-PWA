<!DOCTYPE html>
<html lang="es" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Profesional de AC</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Calculadora AC Pro">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <!-- Colores del tema basados en el logo -->
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#1A5F7A" media="(prefers-color-scheme: dark)">

    <!-- Librerías Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* ... (estilos existentes) ... */

        /* SOLUCIÓN: Estilos específicos para PDF */
        .pdf-export #consumption-table {
            font-size: 14px;
            table-layout: fixed;
            width: 100%;
        }
        .pdf-export #consumption-table td, 
        .pdf-export #consumption-table th {
            padding: 4px 8px;
            white-space: nowrap;
        }
        .pdf-export #consumption-table td:nth-child(1),
        .pdf-export #consumption-table th:nth-child(1) {
            width: 40%;
        }
        .pdf-export #consumption-table td:nth-child(2),
        .pdf-export #consumption-table th:nth-child(2),
        .pdf-export #consumption-table td:nth-child(3),
        .pdf-export #consumption-table th:nth-child(3) {
            width: 30%;
            text-align: right;
        }

        /* ... (otros estilos existentes) ... */
    </style>
</head>
<body class="p-4">
<!-- ... (código HTML existente) ... -->

<!-- App Script -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ... (código JavaScript existente) ...

        // Función optimizada para generar PDF
        const generateOptimizedPDF = () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const city = document.getElementById('city').value || 'Ubicación General';
            const title = `Reporte de Cálculo - ${city}`;
            const reportContent = document.getElementById('report-content');
            
            if (!reportContent) {
                console.error('Elemento #report-content no encontrado');
                return;
            }

            // Opciones optimizadas para html2canvas
            const options = {
                scale: 2,  // No exceder scale:3 por problemas de memoria
                useCORS: true,
                logging: false,
                backgroundColor: '#FFFFFF',
                onclone: (clonedDoc) => {
                    const clonedContent = clonedDoc.getElementById('report-content');
                    if (clonedContent) clonedContent.classList.add('pdf-export');
                }
            };

            // Capturar contenido con estilos específicos
            html2canvas(reportContent, options).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.setFontSize(16);
                pdf.text(title, 10, 15);
                
                pdf.addImage(imgData, 'PNG', 10, 25, pdfWidth - 20, Math.min(imgHeight, pdfHeight - 35));
                
                pdf.save(`reporte-calculo-ac-${city.replace(/\s/g, '_') || 'general'}.pdf`);
            });
        };

        // Actualizar el evento de descarga para usar el método optimizado
        document.getElementById('download-pdf').addEventListener('click', generateOptimizedPDF);
        
        // ... (resto del código JavaScript) ...
    });
</script>
</body>
</html>
